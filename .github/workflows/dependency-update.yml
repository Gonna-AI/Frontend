# =============================================================================
# Automated Dependency Updates
# =============================================================================
# Keeps dependencies fresh with regular update PRs
# Schedule: Every Wednesday at 10 AM UTC
# =============================================================================

name: "Dependency Updates"

on:
  schedule:
    - cron: "0 10 * * 3" # Every Wednesday at 10 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: "Update Dependencies"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "Install Dependencies"
        run: npm ci

      - name: "Check for Updates"
        id: check-updates
        run: |
          echo "Checking for outdated packages..."
          
          # Get outdated packages
          npm outdated --json > outdated.json || true
          
          # Count updates available
          OUTDATED_COUNT=$(cat outdated.json | jq 'length')
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "Found $OUTDATED_COUNT packages with updates available"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "All packages are up to date!"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: "Update Minor & Patch Versions"
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          echo "Updating packages (minor & patch only)..."
          npx npm-check-updates -u --target minor
          npm install

      - name: "Run Tests"
        if: steps.check-updates.outputs.has_updates == 'true'
        continue-on-error: true
        run: |
          npm run build || echo "Build check completed"

      - name: "Create Pull Request"
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update dependencies [bot]"
          title: "Dependency Updates - Week ${{ github.run_number }}"
          body: |
            ## Automated Dependency Updates
            
            This PR updates dependencies to their latest **minor and patch** versions.
            
            ### Summary
            - Packages checked: See workflow logs
            - Update type: Minor & Patch only (safe updates)
            
            ### Checks Performed
            - [x] Package installation successful
            - [x] Build verification attempted
            
            ### Review Checklist
            - [ ] Review changelog for updated packages
            - [ ] Verify application works correctly
            - [ ] Check for any deprecation warnings
            
            ---
            
            Generated by [Dependency Update Workflow](../actions/runs/${{ github.run_id }})
          branch: "deps/weekly-update-${{ github.run_number }}"
          delete-branch: true
          labels: |
            dependencies
            automated
            chore

  # ===========================================================================
  # Monthly Major Updates Check (Creates Issue, not PR)
  # ===========================================================================
  check-major-updates:
    name: "Check Major Updates"
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 10 * * 3' && (github.run_number % 4 == 0)
    
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "Check for Major Updates"
        id: major-check
        run: |
          npm ci
          npx npm-check-updates --json > major-updates.json || true
          
          MAJOR_COUNT=$(cat major-updates.json | jq 'to_entries | map(select(.value | test("^[0-9]"))) | length')
          echo "major_count=$MAJOR_COUNT" >> $GITHUB_OUTPUT

      - name: "Create Issue for Major Updates"
        if: steps.major-check.outputs.major_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const updates = JSON.parse(fs.readFileSync('major-updates.json', 'utf8'));
            
            const updateList = Object.entries(updates)
              .map(([pkg, version]) => `- \`${pkg}\`: ${version}`)
              .join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Major Dependency Updates Available (Monthly Review)`,
              body: `## Major Updates Available\n\nThe following packages have major version updates available:\n\n${updateList}\n\n### Important\nMajor updates may include breaking changes. Please review changelogs before updating.\n\n---\n> This issue was automatically created by the Dependency Update workflow.`,
              labels: ['dependencies', 'review-needed']
            });
