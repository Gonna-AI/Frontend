# =============================================================================
# Documentation & Changelog Generator
# =============================================================================
# Generates changelog from commits and updates documentation
# Schedule: First of every month at 8 AM UTC
# =============================================================================

name: "Documentation & Changelog"

on:
  schedule:
    - cron: "0 8 1 * *" # First day of each month
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-changelog:
    name: "Generate Changelog"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Generate Changelog"
        id: changelog
        run: |
          echo "Generating changelog from git history..."
          
          # Get commits from last month
          LAST_MONTH=$(date -d "1 month ago" +%Y-%m-%d)
          
          echo "# Changelog" > CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          echo "## $(date +%B\ %Y)" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          
          # Features
          echo "### Features" >> CHANGELOG_NEW.md
          git log --since="$LAST_MONTH" --pretty=format:"- %s (%h)" --grep="feat" --grep="feature" --grep="add" -i | head -20 >> CHANGELOG_NEW.md || echo "- No new features this period" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          
          # Bug Fixes
          echo "### Bug Fixes" >> CHANGELOG_NEW.md
          git log --since="$LAST_MONTH" --pretty=format:"- %s (%h)" --grep="fix" --grep="bug" -i | head -20 >> CHANGELOG_NEW.md || echo "- No bug fixes this period" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          
          # Security
          echo "### Security" >> CHANGELOG_NEW.md
          git log --since="$LAST_MONTH" --pretty=format:"- %s (%h)" --grep="security" --grep="vulnerability" -i | head -10 >> CHANGELOG_NEW.md || echo "- No security updates this period" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          
          # Dependencies
          echo "### Dependencies" >> CHANGELOG_NEW.md
          git log --since="$LAST_MONTH" --pretty=format:"- %s (%h)" --grep="deps" --grep="dependencies" --grep="bump" -i | head -10 >> CHANGELOG_NEW.md || echo "- No dependency updates this period" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          
          echo "---" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          
          # Append old changelog if exists
          if [ -f "CHANGELOG.md" ]; then
            tail -n +2 CHANGELOG.md >> CHANGELOG_NEW.md
          fi
          
          mv CHANGELOG_NEW.md CHANGELOG.md
          
          # Check if changelog changed
          if git diff --quiet CHANGELOG.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: "Create Pull Request"
        if: steps.changelog.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: update changelog for $(date +%B\ %Y) [bot]"
          title: "Monthly Changelog Update - $(date +%B\ %Y)"
          body: |
            ## Monthly Changelog Update
            
            This PR updates the changelog with commits from the past month.
            
            ### Categories Included
            - Features
            - Bug Fixes
            - Security Updates
            - Dependencies
            
            ---
            
            Generated by [Documentation Workflow](../actions/runs/${{ github.run_id }})
          branch: "docs/changelog-$(date +%Y-%m)"
          delete-branch: true
          labels: |
            documentation
            automated
            changelog

  # Generate contributor stats
  contributor-stats:
    name: "Update Contributors"
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Generate Contributor Stats"
        run: |
          echo "Top contributors this month:"
          git shortlog -sn --since="1 month ago" | head -10
